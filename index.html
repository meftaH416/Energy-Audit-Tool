<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Energy Audit Tool</title>
  <meta name="Author" content="Meftah Uddin">
  <meta name="Company" content="University of Missouri Columbia">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <style>
    body {
      font-family: Arial, Helvetica, sans-serif;
      background-color: #f1f4f6;
      color: #262626;
      margin: 20px;
      line-height: 1.5;
    }
    h1, h2, h3 { color: #262626; }
    .container {
      max-width: 960px;
      margin: 0 auto;
      background: white;
      padding: 24px;
      border-radius: 8px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
    }
    .section { margin-bottom: 32px; }
    .basic-info label {
      display: inline-block;
      width: 180px;
      font-weight: bold;
      vertical-align: top;
      padding-top: 8px;
    }
    .basic-info input,
    .basic-info textarea {
      padding: 8px;
      border: 1px solid #ccc;
      border-radius: 4px;
      width: 100%;
      max-width: 500px;
      box-sizing: border-box;
    }
    .equipment-type-block {
      border: 1px solid #bbb;
      border-radius: 8px;
      padding: 16px;
      margin-bottom: 24px;
      background: #f8f9fa;
    }
    .equipment-type-header {
      font-size: 1.3em;
      font-weight: bold;
      color: #0066cc;
      margin-bottom: 12px;
    }
    .instance-container {
      margin-left: 16px;
      margin-top: 12px;
    }
    .equipment-instance {
      border: 1px dashed #999;
      border-radius: 6px;
      padding: 14px;
      margin-bottom: 16px;
      background: white;
      position: relative;
    }
    .instance-header {
      font-weight: bold;
      color: #2c3e50;
      margin-bottom: 10px;
    }
    .delete-btn {
      position: absolute;
      top: 10px;
      right: 10px;
      background: #c0392b;
      color: white;
      border: none;
      padding: 6px 10px;
      border-radius: 4px;
      cursor: pointer;
      font-size: 0.9em;
    }
    .input-row {
      display: flex;
      align-items: center;
      gap: 10px;
      margin-bottom: 10px;
    }
    .input-row input {
      flex: 1;
      padding: 8px;
      border: 1px solid #ccc;
      border-radius: 4px;
    }
    .add-btn, .delete-input-btn {
      padding: 6px 12px;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      font-weight: bold;
    }
    .add-btn { background: #27ae60; color: white; }
    .delete-input-btn { background: #e67e22; color: white; }
    .photo-upload { margin-top: 12px; }
    .photo-preview-container {
      display: flex;
      flex-wrap: wrap;
      gap: 12px;
      margin-top: 8px;
    }
    .photo-preview-container img {
      max-width: 220px;
      border: 1px solid #ddd;
      border-radius: 4px;
    }
    button.global-action {
      margin-right: 12px;
      padding: 10px 18px;
      font-size: 1em;
      cursor: pointer;
      border: none;
      border-radius: 6px;
      color: white;
    }
    #add-equipment-type { background: #3498db; }
    #download-pdf { background: #8e44ad; }
    input, textarea { font-family: inherit; }
    #draft-status {
      font-size: 0.9em;
      color: #555;
      margin: 10px 0;
    }
    #pdf-progress {
      display: none;
      background: #fff3cd;
      border: 1px solid #ffc107;
      padding: 15px;
      margin: 15px 0;
      border-radius: 5px;
      text-align: center;
    }
    .storage-info {
      background: #e8f5e9;
      border: 1px solid #4caf50;
      padding: 10px;
      margin: 10px 0;
      border-radius: 4px;
      font-size: 0.9em;
    }
  </style>
</head>
<body>
<div class="container" id="content-to-pdf">
  <p style="text-align:center; color:#0000e9; margin-bottom: 24px;">
    Created by <a href="https://www.linkedin.com/in/meftah-uddin-972a78125/">Meftah Uddin</a> |
    Web: <a href="https://meftah416.github.io/MeftahUddin.github.io/">MeftahUddin.github.io</a>
  </p>
  <h1>Energy Audit Tool - Unlimited Storage</h1>
  <div class="storage-info" id="storage-info">
    üíæ Using IndexedDB - Supports 50+ photos | <span id="photo-count">0 photos stored</span>
  </div>
  <div id="draft-status">Loading...</div>
  <div id="pdf-progress">Generating PDF... Please wait.</div>

  <div class="section">
    <h2>Basic Information</h2>
    <div class="basic-info">
      <p><label for="name">Company Name:</label> <input type="text" id="name"></p>
      <p><label for="auditor">Auditor Name:</label> <input type="text" id="auditor"></p>
      <p><label for="address">Company Address:</label> <input type="text" id="address"></p>
      <p><label for="date">Audit Date:</label> <input type="date" id="date"></p>
      <p><label for="products">Products Produced:</label> <input type="text" id="products"></p>
      <p><label for="volume">Product Volume:</label> <input type="text" id="volume"></p>
      <p><label for="shift">Operating Hours:</label> <input type="text" id="shift" placeholder=""></p>
      <p><label for="employee">No of Employees:</label> <input type="number" id="employee"></p>
      <p><label for="raw-materials">Raw Materials:</label> <textarea id="raw-materials" rows="2" placeholder=""></textarea></p>
      <p><label for="plant-area">Plant Area:</label> <textarea id="plant-area" rows="3" placeholder=""></textarea></p>
      <p>
        <label>Plant Layout:</label><br>
        <input type="file" accept="image/*" id="plant-layout" capture="environment">
        <small>(Camera on mobile ‚Ä¢ File picker on PC ‚Ä¢ Auto-compressed for storage)</small>
        <div id="plant-photo-preview" class="photo-preview-container"></div>
      </p>
      <p><label for="process-flow">Process Description:</label> <textarea id="process-flow" rows="3" placeholder=""></textarea></p>
      <p>
        <label>Process Flow Diagram:</label><br>
        <input type="file" accept="image/*" id="process-photo" capture="environment">
        <small>(Camera on mobile ‚Ä¢ File picker on PC ‚Ä¢ Auto-compressed for storage)</small>
        <div id="process-photo-preview" class="photo-preview-container"></div>
      </p>
    </div>
  </div>

  <div class="section">
    <h2>Equipment Details</h2>
    <div id="equipment-types-container"></div>
    <div style="margin: 28px 0;">
      <button id="add-equipment-type" class="global-action">‚ûï Add Equipment Type</button>
      <button id="download-pdf" class="global-action">üìÑ Download PDF</button>
      <button id="clear-draft" class="global-action" style="background:#e74c3c;">üóëÔ∏è Clear Draft</button>
    </div>
  </div>
</div>

<script>
  // ================== IndexedDB Setup ==================
  const DB_NAME = 'EnergyAuditDB';
  const DB_VERSION = 1;
  const STORE_NAME = 'auditData';
  const PHOTOS_STORE = 'photos';
  let db;

  // Initialize IndexedDB
  function initDB() {
    return new Promise((resolve, reject) => {
      const request = indexedDB.open(DB_NAME, DB_VERSION);
      
      request.onerror = () => reject(request.error);
      request.onsuccess = () => {
        db = request.result;
        resolve(db);
      };
      
      request.onupgradeneeded = (event) => {
        const db = event.target.result;
        
        // Create object stores if they don't exist
        if (!db.objectStoreNames.contains(STORE_NAME)) {
          db.createObjectStore(STORE_NAME, { keyPath: 'id' });
        }
        if (!db.objectStoreNames.contains(PHOTOS_STORE)) {
          db.createObjectStore(PHOTOS_STORE, { keyPath: 'id', autoIncrement: true });
        }
      };
    });
  }

  // Save data to IndexedDB
  function saveToIndexedDB(key, data) {
    return new Promise((resolve, reject) => {
      const transaction = db.transaction([STORE_NAME], 'readwrite');
      const store = transaction.objectStore(STORE_NAME);
      const request = store.put({ id: key, data: data });
      
      request.onsuccess = () => resolve();
      request.onerror = () => reject(request.error);
    });
  }

  // Get data from IndexedDB
  function getFromIndexedDB(key) {
    return new Promise((resolve, reject) => {
      const transaction = db.transaction([STORE_NAME], 'readonly');
      const store = transaction.objectStore(STORE_NAME);
      const request = store.get(key);
      
      request.onsuccess = () => resolve(request.result?.data);
      request.onerror = () => reject(request.error);
    });
  }

  // Save photo to IndexedDB
  function savePhoto(photoData) {
    return new Promise((resolve, reject) => {
      const transaction = db.transaction([PHOTOS_STORE], 'readwrite');
      const store = transaction.objectStore(PHOTOS_STORE);
      const request = store.add({ data: photoData, timestamp: Date.now() });
      
      request.onsuccess = () => resolve(request.result); // Returns the photo ID
      request.onerror = () => reject(request.error);
    });
  }

  // Get photo from IndexedDB
  function getPhoto(photoId) {
    return new Promise((resolve, reject) => {
      const transaction = db.transaction([PHOTOS_STORE], 'readonly');
      const store = transaction.objectStore(PHOTOS_STORE);
      const request = store.get(photoId);
      
      request.onsuccess = () => resolve(request.result?.data);
      request.onerror = () => reject(request.error);
    });
  }

  // Get all photos
  function getAllPhotos() {
    return new Promise((resolve, reject) => {
      const transaction = db.transaction([PHOTOS_STORE], 'readonly');
      const store = transaction.objectStore(PHOTOS_STORE);
      const request = store.getAll();
      
      request.onsuccess = () => resolve(request.result);
      request.onerror = () => reject(request.error);
    });
  }

  // Clear all data
  function clearAllData() {
    return new Promise((resolve, reject) => {
      const transaction = db.transaction([STORE_NAME, PHOTOS_STORE], 'readwrite');
      
      transaction.objectStore(STORE_NAME).clear();
      transaction.objectStore(PHOTOS_STORE).clear();
      
      transaction.oncomplete = () => resolve();
      transaction.onerror = () => reject(transaction.error);
    });
  }

  // ================== Image Compression ==================
  function compressImage(file, maxWidth = 1200, quality = 0.8) {
    return new Promise((resolve, reject) => {
      const reader = new FileReader();
      reader.onload = (e) => {
        const img = new Image();
        img.onload = () => {
          const canvas = document.createElement('canvas');
          let width = img.width;
          let height = img.height;
          
          // Calculate new dimensions
          if (width > maxWidth) {
            height = (height / width) * maxWidth;
            width = maxWidth;
          }
          
          canvas.width = width;
          canvas.height = height;
          
          const ctx = canvas.getContext('2d');
          ctx.drawImage(img, 0, 0, width, height);
          
          // Convert to base64 with compression
          const compressed = canvas.toDataURL('image/jpeg', quality);
          resolve(compressed);
        };
        img.onerror = reject;
        img.src = e.target.result;
      };
      reader.onerror = reject;
      reader.readAsDataURL(file);
    });
  }

  // ================== Core Variables ==================
  let typeCounter = 0;
  const container = document.getElementById('equipment-types-container');

  // ================== Utilities ==================
  function debounce(fn, delay = 800) {
    let timer;
    return (...args) => {
      clearTimeout(timer);
      timer = setTimeout(() => fn(...args), delay);
    };
  }
  const debouncedSave = debounce(saveDraft);

  // Update photo count
  async function updatePhotoCount() {
    try {
      const photos = await getAllPhotos();
      document.getElementById('photo-count').textContent = `${photos.length} photos stored`;
    } catch (err) {
      console.error('Error counting photos:', err);
    }
  }

  // ================== Core Functions ==================
  async function getFormState() {
    const state = {
      basic: {
        name: document.getElementById('name')?.value || '',
        auditor: document.getElementById('auditor')?.value || '',
        address: document.getElementById('address')?.value || '',
        date: document.getElementById('date')?.value || '',
        products: document.getElementById('products')?.value || '',
        volume: document.getElementById('volume')?.value || '',
        shift: document.getElementById('shift')?.value || '',
        employee: document.getElementById('employee')?.value || '',
        'raw-materials': document.getElementById('raw-materials')?.value || '',
        'plant-area': document.getElementById('plant-area')?.value || '',
        'process-flow': document.getElementById('process-flow')?.value || '',
      },
      plantLayoutPhotoId: null,
      processPhotoId: null,
      equipmentTypes: []
    };

    // Get plant layout photo ID
    const plantImg = document.getElementById('plant-photo-preview')?.querySelector('img');
    if (plantImg && plantImg.dataset.photoId) {
      state.plantLayoutPhotoId = parseInt(plantImg.dataset.photoId);
    }

    // Get process photo ID
    const processImg = document.getElementById('process-photo-preview')?.querySelector('img');
    if (processImg && processImg.dataset.photoId) {
      state.processPhotoId = parseInt(processImg.dataset.photoId);
    }

    // Get equipment types
    document.querySelectorAll('.equipment-type-block').forEach(typeBlock => {
      const typeName = typeBlock.querySelector('input[id^="type-name-"]')?.value.trim() || '';
      const typeState = { name: typeName, instances: [] };
      
      typeBlock.querySelectorAll('.equipment-instance').forEach(instance => {
        const desc = instance.querySelector('textarea')?.value.trim() || '';
        const hours = instance.querySelector('input[type="text"]')?.value.trim() || '';
        const photoIds = Array.from(instance.querySelectorAll('.instance-photo-preview img'))
          .filter(img => img.dataset.photoId)
          .map(img => parseInt(img.dataset.photoId));
        
        typeState.instances.push({ desc, hours, photoIds });
      });
      
      if (typeName || typeState.instances.length > 0) {
        state.equipmentTypes.push(typeState);
      }
    });
    
    return state;
  }

  async function saveDraft() {
    try {
      const state = await getFormState();
      const hasContent = Object.values(state.basic).some(v => v.trim()) ||
                         state.plantLayoutPhotoId ||
                         state.processPhotoId ||
                         state.equipmentTypes.length > 0;

      if (hasContent) {
        await saveToIndexedDB('draft', state);
        document.getElementById('draft-status').textContent =
          `‚úì Draft auto-saved at ${new Date().toLocaleTimeString()}`;
        document.getElementById('draft-status').style.color = '#27ae60';
        await updatePhotoCount();
      } else {
        document.getElementById('draft-status').textContent = 'No data to save yet';
        document.getElementById('draft-status').style.color = '#999';
      }
    } catch (err) {
      console.error("Error saving draft:", err);
      document.getElementById('draft-status').textContent = '‚ö† Save failed';
      document.getElementById('draft-status').style.color = '#e74c3c';
    }
  }

  async function restoreDraft() {
    try {
      const state = await getFromIndexedDB('draft');
      if (!state) {
        document.getElementById('draft-status').textContent = 'No saved draft - start entering data';
        document.getElementById('draft-status').style.color = '#999';
        await updatePhotoCount();
        return;
      }

      // Restore basic fields
      if (state.basic) {
        Object.entries(state.basic).forEach(([id, val]) => {
          const el = document.getElementById(id);
          if (el) el.value = val || '';
        });
      }

      // Restore Plant Layout photo
      if (state.plantLayoutPhotoId) {
        const photoData = await getPhoto(state.plantLayoutPhotoId);
        if (photoData) {
          const preview = document.getElementById('plant-photo-preview');
          preview.innerHTML = '';
          const img = document.createElement('img');
          img.src = photoData;
          img.dataset.photoId = state.plantLayoutPhotoId;
          preview.appendChild(img);
        }
      }

      // Restore Process Flow photo
      if (state.processPhotoId) {
        const photoData = await getPhoto(state.processPhotoId);
        if (photoData) {
          const preview = document.getElementById('process-photo-preview');
          preview.innerHTML = '';
          const img = document.createElement('img');
          img.src = photoData;
          img.dataset.photoId = state.processPhotoId;
          preview.appendChild(img);
        }
      }

      // Restore equipment
      if (state.equipmentTypes?.length > 0) {
        container.innerHTML = '';
        typeCounter = 0;

        for (const typeData of state.equipmentTypes) {
          addEquipmentType(true);
          const typeBlock = container.lastElementChild;
          const typeNameInput = typeBlock.querySelector('input[id^="type-name-"]');
          if (typeNameInput) typeNameInput.value = typeData.name || '';

          const instancesDiv = typeBlock.querySelector('.instance-container');

          for (const instData of typeData.instances) {
            addInstance(typeBlock.id, typeCounter, true);
            const instance = instancesDiv.lastElementChild;
            
            if (instance) {
              instance.querySelector('textarea').value = instData.desc || '';
              instance.querySelector('input[type="text"]').value = instData.hours || '';

              // Restore photos
              for (const photoId of (instData.photoIds || [])) {
                const photoData = await getPhoto(photoId);
                if (photoData) {
                  addPhotoInput(instance.id);
                  const allWrappers = Array.from(instance.querySelectorAll('.instance-photo-preview'))
                    .map(div => div.parentElement)
                    .filter(el => el.querySelector('input[type="file"]'));
                  const lastWrapper = allWrappers[allWrappers.length - 1];
                  
                  if (lastWrapper) {
                    const photoPreviewDiv = lastWrapper.querySelector('.instance-photo-preview');
                    if (photoPreviewDiv) {
                      const img = document.createElement('img');
                      img.src = photoData;
                      img.dataset.photoId = photoId;
                      photoPreviewDiv.appendChild(img);
                    }
                  }
                }
              }
            }
          }
        }
      }

      document.getElementById('draft-status').textContent = '‚úì Draft restored from previous session';
      document.getElementById('draft-status').style.color = '#3498db';
      await updatePhotoCount();
    } catch (err) {
      console.error("Error restoring draft:", err);
      document.getElementById('draft-status').textContent = '‚ö† Error restoring draft';
      document.getElementById('draft-status').style.color = '#e74c3c';
    }
  }

  async function clearDraft() {
    if (confirm("Clear ALL saved draft data including all photos? This cannot be undone.")) {
      try {
        await clearAllData();
        window.location.reload();
      } catch (err) {
        console.error("Error clearing draft:", err);
        alert("Failed to clear draft. Please try again.");
      }
    }
  }

  function attachAutoSave() {
    document.querySelectorAll('input, textarea, [type="file"]').forEach(el => {
      el.removeEventListener('input', debouncedSave);
      el.removeEventListener('change', debouncedSave);
      el.addEventListener('input', debouncedSave);
      el.addEventListener('change', debouncedSave);
    });
  }

  // ================== UI Builders ==================
  function addEquipmentType(skipDefaultInstance = false) {
    typeCounter++;
    const typeId = `type-${typeCounter}`;
    const typeBlock = document.createElement('div');
    typeBlock.className = 'equipment-type-block';
    typeBlock.id = typeId;
    typeBlock.innerHTML = `
      <div class="equipment-type-header">
        Equipment Type #${typeCounter}
        <button class="delete-btn" onclick="deleteType('${typeId}')" style="margin-left:20px; position:static; background:#7f8c8d;">Delete Type</button>
      </div>
      <p><strong>Equipment Type / Name:</strong><br>
        <input type="text" id="type-name-${typeCounter}" placeholder="">
      </p>
      <div style="margin: 16px 0;">
        <button class="add-btn" onclick="addInstance('${typeId}', ${typeCounter})">+ Add Instance</button>
      </div>
      <div class="instance-container" id="instances-${typeId}"></div>
    `;
    container.appendChild(typeBlock);
    if (!skipDefaultInstance) {
      addInstance(typeId, typeCounter);
    }
    attachAutoSave();
  }

  function addInstance(typeId, typeNum, skipDefaults = false) {
    const instancesDiv = document.getElementById(`instances-${typeId}`);
    const currentInstances = instancesDiv.querySelectorAll('.equipment-instance').length;
    const instanceNumber = currentInstances + 1;
    const instId = `inst-${typeId}-${instanceNumber}`;
    const instance = document.createElement('div');
    instance.className = 'equipment-instance';
    instance.id = instId;
    instance.innerHTML = `
      <button class="delete-btn" onclick="deleteInstance('${instId}')">Delete</button>
      <div class="instance-header">Instance #${instanceNumber}</div>
      <p><strong>Description / Model / Location:</strong><br>
        <textarea placeholder="" rows="2"></textarea>
      </p>
      <p><strong>Hours of Operation:</strong><br>
        <input type="text" placeholder="">
      </p>
      
      <div class="photo-upload">
        <strong>Photos / Snapshots:</strong><br>
        <button type="button" class="add-btn" onclick="addPhotoInput('${instId}')">+ Add Photo</button>
        <div class="instance-photo-preview photo-preview-container" id="photo-preview-${instId}"></div>
      </div>
    `;
    instancesDiv.appendChild(instance);

    if (!skipDefaults) {
      addPhotoInput(instId);
    }

    attachAutoSave();
  }

  function addPhotoInput(instId) {
    const previewContainer = document.getElementById(`photo-preview-${instId}`);
    const input = document.createElement('input');
    input.type = 'file';
    input.accept = 'image/*';
    input.capture = 'environment';
    input.style.margin = '8px 0';

    const removeBtn = document.createElement('button');
    removeBtn.type = 'button';
    removeBtn.textContent = 'Remove';
    removeBtn.className = 'delete-input-btn';
    removeBtn.style.marginLeft = '10px';
    removeBtn.onclick = () => { wrapper.remove(); debouncedSave(); };

    const wrapper = document.createElement('div');
    wrapper.style.display = 'flex';
    wrapper.style.alignItems = 'center';
    wrapper.appendChild(input);
    wrapper.appendChild(removeBtn);

    const photoPreviewDiv = document.createElement('div');
    photoPreviewDiv.className = 'instance-photo-preview';
    wrapper.appendChild(photoPreviewDiv);

    input.addEventListener('change', async (e) => {
      const file = e.target.files[0];
      if (!file) return;
      
      try {
        // Show loading message
        photoPreviewDiv.innerHTML = '<small>Compressing...</small>';
        
        // Compress image
        const compressed = await compressImage(file);
        
        // Save to IndexedDB
        const photoId = await savePhoto(compressed);
        
        // Display preview
        const img = document.createElement('img');
        img.src = compressed;
        img.dataset.photoId = photoId;
        photoPreviewDiv.innerHTML = '';
        photoPreviewDiv.appendChild(img);
        
        debouncedSave();
      } catch (err) {
        console.error('Error processing image:', err);
        photoPreviewDiv.innerHTML = '<small style="color:red;">Error loading image</small>';
      }
    });

    previewContainer.parentElement.insertBefore(wrapper, previewContainer);
    attachAutoSave();
  }

  function deleteInstance(instId) {
    if (confirm("Delete this instance?")) {
      document.getElementById(instId)?.remove();
      debouncedSave();
    }
  }

  function deleteType(typeId) {
    if (confirm("Delete this equipment type and all its instances?")) {
      document.getElementById(typeId)?.remove();
      debouncedSave();
    }
  }

  // ================== PDF Generation ==================
  document.getElementById('download-pdf').onclick = async () => {
    if (!window.jspdf?.jsPDF) {
      alert("PDF library not loaded. Check internet connection.");
      return;
    }

    const progressDiv = document.getElementById('pdf-progress');
    progressDiv.style.display = 'block';

    try {
      const { jsPDF } = window.jspdf;
      const pdf = new jsPDF('p', 'mm', 'a4');
      const pageWidth = 210;
      const pageHeight = 297;
      const margin = 15;
      const maxWidth = pageWidth - 2 * margin;
      let y = margin;

      const checkPageBreak = (neededSpace = 15) => {
        if (y + neededSpace > pageHeight - margin) {
          pdf.addPage();
          y = margin;
        }
      };

      const addText = (text, fontSize = 11, isBold = false) => {
        checkPageBreak();
        pdf.setFontSize(fontSize);
        pdf.setFont(undefined, isBold ? 'bold' : 'normal');
        const lines = pdf.splitTextToSize(text, maxWidth);
        pdf.text(lines, margin, y);
        y += lines.length * (fontSize * 0.4) + 3;
      };

      const addImage = async (photoId, label) => {
        if (!photoId) return;
        
        checkPageBreak(8);
        addText(label, 10, true);
        
        try {
          const imgSrc = await getPhoto(photoId);
          if (!imgSrc) return;
          
          const img = new Image();
          img.src = imgSrc;
          await new Promise((resolve, reject) => {
            img.onload = resolve;
            img.onerror = reject;
          });

          const aspectRatio = img.width / img.height;
          const maxImgWidth = maxWidth;
          const maxImgHeight = 90;
          
          let imgWidth, imgHeight;
          
          if (aspectRatio > 1) {
            imgWidth = maxImgWidth;
            imgHeight = imgWidth / aspectRatio;
            if (imgHeight > maxImgHeight) {
              imgHeight = maxImgHeight;
              imgWidth = imgHeight * aspectRatio;
            }
          } else {
            imgHeight = maxImgHeight;
            imgWidth = imgHeight * aspectRatio;
            if (imgWidth > maxImgWidth) {
              imgWidth = maxImgWidth;
              imgHeight = imgWidth / aspectRatio;
            }
          }
          
          const remainingSpace = pageHeight - margin - y;
          const requiredSpace = imgHeight + 5;
          
          if (requiredSpace > remainingSpace) {
            pdf.addPage();
            y = margin;
          }
          
          if (y + imgHeight > pageHeight - margin) {
            pdf.addPage();
            y = margin;
          }
          
          pdf.addImage(imgSrc, 'JPEG', margin, y, imgWidth, imgHeight);
          y += imgHeight + 6;
          
        } catch (err) {
          console.error("Error adding image:", err);
          addText("[Image could not be loaded]", 9);
        }
      };

      // Title
      pdf.setFontSize(20);
      pdf.setFont(undefined, 'bold');
      pdf.text("Energy Audit Report", margin, y);
      y += 12;

      pdf.setFontSize(10);
      pdf.setFont(undefined, 'normal');
      pdf.text(`Generated: ${new Date().toLocaleString()}`, margin, y);
      y += 12;

      // Basic Information
      addText("1. BASIC INFORMATION", 14, true);
      y += 3;

      const basicFields = [
        ["Company Name", document.getElementById("name")?.value],
        ["Auditor Name", document.getElementById("auditor")?.value],
        ["Address", document.getElementById("address")?.value],
        ["Audit Date", document.getElementById("date")?.value],
        ["Products Produced", document.getElementById("products")?.value],
        ["Product Volume", document.getElementById("volume")?.value],
        ["Operating Hours", document.getElementById("shift")?.value],
        ["Number of Employees", document.getElementById("employee")?.value],
        ["Raw Materials", document.getElementById("raw-materials")?.value],
        ["Plant Area", document.getElementById("plant-area")?.value],
        ["Process Description", document.getElementById("process-flow")?.value],
      ];

      for (const [label, value] of basicFields) {
        if (value?.trim()) {
          addText(`${label}: ${value.trim()}`, 11);
        }
      }

      y += 5;

      // Plant Layout Photo
      const plantImg = document.getElementById('plant-photo-preview')?.querySelector('img');
      if (plantImg && plantImg.dataset.photoId) {
        await addImage(parseInt(plantImg.dataset.photoId), "Plant Layout:");
      }

      // Process Flow Photo
      const processImg = document.getElementById('process-photo-preview')?.querySelector('img');
      if (processImg && processImg.dataset.photoId) {
        await addImage(parseInt(processImg.dataset.photoId), "Process Flow Diagram:");
      }

      y += 10;

      // Equipment Details
      checkPageBreak(20);
      addText("2. EQUIPMENT DETAILS", 14, true);
      y += 5;

      const equipmentTypes = document.querySelectorAll('.equipment-type-block');
      
      if (equipmentTypes.length === 0) {
        addText("No equipment data entered.", 11);
      } else {
        let typeNum = 1;
        for (const typeBlock of equipmentTypes) {
          checkPageBreak(25);
          
          const typeName = typeBlock.querySelector('input[id^="type-name-"]')?.value.trim() || `Equipment Type ${typeNum}`;
          addText(`${typeNum}. ${typeName}`, 12, true);
          y += 2;
          
          const instances = typeBlock.querySelectorAll('.equipment-instance');
          let instNum = 1;
          
          for (const instance of instances) {
            checkPageBreak(20);
            addText(`  Instance ${instNum}:`, 11, true);
            
            const desc = instance.querySelector('textarea')?.value.trim();
            if (desc) {
              checkPageBreak(15);
              addText(`    Description: ${desc}`, 10);
            }
            
            const hours = instance.querySelector('input[type="text"]')?.value.trim();
            if (hours) {
              checkPageBreak(10);
              addText(`    Operating Hours: ${hours}`, 10);
            }
            
            // Instance photos
            const photos = instance.querySelectorAll('.instance-photo-preview img');
            if (photos.length > 0) {
              y += 3;
              let photoNum = 1;
              for (const photo of photos) {
                if (photo.dataset.photoId) {
                  const estimatedPhotoSpace = 60;
                  if (y + estimatedPhotoSpace > pageHeight - margin) {
                    pdf.addPage();
                    y = margin;
                  }
                  await addImage(parseInt(photo.dataset.photoId), `    Photo ${photoNum}:`);
                  photoNum++;
                }
              }
            }
            
            y += 8;
            instNum++;
          }
          
          y += 5;
          typeNum++;
        }
      }

      // Save PDF
      const companyName = document.getElementById("name")?.value.trim() || "Energy_Audit";
      const date = document.getElementById("date")?.value || new Date().toISOString().split('T')[0];
      const filename = `${companyName.replace(/\s+/g, '_')}_Energy_Audit_${date}.pdf`;
      
      pdf.save(filename);
      
      progressDiv.style.display = 'none';
      alert("PDF generated successfully!");
      
    } catch (err) {
      progressDiv.style.display = 'none';
      alert("PDF generation failed: " + err.message);
      console.error("PDF Error:", err);
    }
  };

  // ================== Init ==================
  document.getElementById('add-equipment-type').addEventListener('click', () => addEquipmentType());
  document.getElementById('clear-draft').addEventListener('click', clearDraft);

  // Plant Layout photo handler
  document.getElementById('plant-layout')?.addEventListener('change', async (e) => {
    const file = e.target.files[0];
    if (!file) return;
    
    const preview = document.getElementById('plant-photo-preview');
    preview.innerHTML = '<small>Compressing image...</small>';
    
    try {
      const compressed = await compressImage(file);
      const photoId = await savePhoto(compressed);
      
      preview.innerHTML = '';
      const img = document.createElement('img');
      img.src = compressed;
      img.dataset.photoId = photoId;
      preview.appendChild(img);
      
      debouncedSave();
    } catch (err) {
      console.error('Error processing image:', err);
      preview.innerHTML = '<small style="color:red;">Error loading image</small>';
    }
  });

  // Process Flow photo handler
  document.getElementById('process-photo').addEventListener('change', async (e) => {
    const file = e.target.files[0];
    if (!file) return;
    
    const preview = document.getElementById('process-photo-preview');
    preview.innerHTML = '<small>Compressing image...</small>';
    
    try {
      const compressed = await compressImage(file);
      const photoId = await savePhoto(compressed);
      
      preview.innerHTML = '';
      const img = document.createElement('img');
      img.src = compressed;
      img.dataset.photoId = photoId;
      preview.appendChild(img);
      
      debouncedSave();
    } catch (err) {
      console.error('Error processing image:', err);
      preview.innerHTML = '<small style="color:red;">Error loading image</small>';
    }
  });

  // Initialize
  initDB()
    .then(() => {
      restoreDraft();
      setTimeout(attachAutoSave, 300);
    })
    .catch(err => {
      console.error('Failed to initialize database:', err);
      alert('Failed to initialize storage. Please use a modern browser.');
    });
</script>
</body>
</html>
